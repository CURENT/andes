name: Python application

on: [push, pull_request]

jobs:
  build:
    name: ANDES Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent hanging workflows

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for versioneer

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # Install uv - much faster than pip/conda
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true

    # Cache uv packages with smart invalidation
    # Cache key changes when requirements files change
    - name: Cache uv packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-py3.11-${{ hashFiles('requirements.txt', 'requirements-extra.txt', 'pyproject.toml') }}
        restore-keys: |
          uv-${{ runner.os }}-py3.11-
          uv-${{ runner.os }}-

    # Install dependencies using uv (10-100x faster than pip)
    - name: Install dependencies
      run: |
        # Create virtual environment
        uv venv

        # Install all dependencies at once (faster)
        uv pip install -r requirements.txt -r requirements-extra.txt

        # Install test tools
        uv pip install nbmake pytest-xdist line_profiler pytest-cov

    # Install ANDES in editable mode
    - name: Install ANDES
      run: |
        uv pip install -e . --no-deps

    # Verify installation
    - name: Verify installation
      run: |
        uv run python -c "import andes; print(f'✓ ANDES {andes.__version__}')"
        uv run python -c "import line_profiler; print('✓ line_profiler installed')"
        uv pip check || echo "Warning: dependency check failed"

    # Lint with flake8
    - name: Lint with flake8
      if: github.event_name == 'pull_request'
      run: |
        uv run flake8 andes tests --count --select=E9,F63,F7,F82 --show-source --statistics
        uv run flake8 andes tests --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

    # Run tests
    - name: Run unit tests
      run: |
        uv run pytest -v --tb=short --durations=10
      timeout-minutes: 15

    # Run notebook tests
    - name: Test notebooks
      run: |
        uv run pytest --nbmake examples --ignore=examples/verification -v
      timeout-minutes: 10

    # Build and publish if tagged
    - name: Build and publish to PyPI
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      run: |
        uv pip install build twine
        uv run python -m build
        uv run twine check dist/*
        uv run twine upload dist/*
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}